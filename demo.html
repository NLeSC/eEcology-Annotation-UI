<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Extjs - Cesium - Helloworld</title>
<link rel="stylesheet" href="extjs/resources/css/ext-all.css"
	type="text/css"></link>
<style>

.play {
  background-image: url(famfamfam_silk_icons/icons/control_play.png) !important;
}

.pause {
  background-image: url(famfamfam_silk_icons/icons/control_pause.png) !important;
}

.rewind {
  background-image: url(famfamfam_silk_icons/icons/control_rewind.png) !important;
}
</style>
<script type="text/javascript" src="extjs/ext-all-dev.js"></script>
<script type="text/javascript" src="cesium/Build/CesiumUnminified/Cesium.js"></script>
<script type="text/javascript">
	var win;
	var cesium_scene;

	Ext.require([
	   'Ext.window.Window',
	   'Ext.form.field.Text',
	   'Ext.form.field.ComboBox'
	]);

	Ext.onReady(function() {
		var animationController;

		Ext.define('Esc.cesium', {
			extend : 'Ext.Component',
			alias: 'widget.cesium',
			autoEl: {
				tag: 'canvas'
			},
			onResize: function() {
                var canvas = this.getEl().dom;
				var width = canvas.clientWidth;
		        var height = canvas.clientHeight;

		        if (canvas.width === width && canvas.height === height) {
		            return;
		        }

		        canvas.width = width;
		        canvas.height = height;

		        var frustum = this.scene.getCamera().frustum;
	            if (typeof frustum.aspectRatio !== 'undefined') {
	                frustum.aspectRatio = width / height;
	            } else {
	                frustum.top = frustum.right * (height / width);
	                frustum.bottom = -frustum.top;
	            }
			},
			afterRender: function() {
				var canvas = this.getEl().dom;
				var ellipsoid = Cesium.Ellipsoid.WGS84;
			    var scene = new Cesium.Scene(canvas);
			    this.scene = scene;

			    // For debugging
			    cesium_scene = scene;

			    var primitives = scene.getPrimitives();
			    var cb = new Cesium.CentralBody(ellipsoid);

			    var imageryUrl = 'cesium/Source/Assets/Textures/';

			    function minimal() {
				    var imageryProvider = new Cesium.SingleTileImageryProvider({
				        url : imageryUrl + 'NE2_LR_LC_SR_W_DR_2048.jpg'
				    });
				    var cb = new Cesium.CentralBody(ellipsoid);
				    cb.getImageryLayers().addImageryProvider(imageryProvider);
			    }
			    //minimal();

			    // Bing Maps
			    var bing = new Cesium.BingMapsImageryProvider({
//	<=b12 version		        server : 'dev.virtualearth.net',
                    url : 'http://dev.virtualearth.net',
                    // expired key can ge updated on https://www.bingmapsportal.com
			        key: 'AksbUphPtrgZ5xecV2NjfwCiWIjlWspCWYuPEb278pLZTmcW1PzRogfL88pXWxYn',
			        mapStyle : Cesium.BingMapsStyle.AERIAL,
			        // Some versions of Safari support WebGL, but don't correctly implement
			        // cross-origin image loading, so we need to load Bing imagery using a proxy.
			        proxy : Cesium.FeatureDetection.supportsCrossOriginImagery() ? undefined : new Cesium.DefaultProxy('/proxy/')
			    });
			    cb.getImageryLayers().addImageryProvider(bing);

			    var osm = new Cesium.OpenStreetMapImageryProvider({
			        url : 'http://tile.openstreetmap.org/'
			    });
			    //cb.getImageryLayers().addImageryProvider(osm);

			    function terrain() {
                var terrainProvider = new Cesium.CesiumTerrainProvider({
                    url : 'http://cesium.agi.com/smallterrain'
                });
                cb.terrainProvider = terrainProvider;
			    }

			    primitives.setCentralBody(cb);
			    scene.skyAtmosphere = new Cesium.SkyAtmosphere();
			    scene.skyBox = new Cesium.SkyBox({
			        positiveX: imageryUrl + 'SkyBox/tycho8_px_80.jpg',
			        negativeX: imageryUrl + 'SkyBox/tycho8_mx_80.jpg',
			        positiveY: imageryUrl + 'SkyBox/tycho8_py_80.jpg',
			        negativeY: imageryUrl + 'SkyBox/tycho8_my_80.jpg',
			        positiveZ: imageryUrl + 'SkyBox/tycho8_pz_80.jpg',
			        negativeZ: imageryUrl + 'SkyBox/tycho8_mz_80.jpg'
			    });

                var dynamicObjectCollection = new Cesium.DynamicObjectCollection();
                var visualizers = Cesium.VisualizerCollection.createCzmlStandardCollection(scene, dynamicObjectCollection);

                function inlineczml() {
	                var czml = [{
			            "id" : "Vehicle",
			            "availability" : "2012-08-04T16:00:00Z/2012-08-04T17:04:54.9962195740191Z",
			            "billboard" : {
			                "eyeOffset" : {
			                    "cartesian" : [0.0, 0.0, 0.0]
			                },
			                "horizontalOrigin" : "CENTER",
			                "image" : "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEISURBVEhLvVXBDYQwDOuojHKj8LhBbpTbpBCEkZsmIVTXq1RVQGrHiWlLmTTqPiZBlyLgy/KSZQ5JSHDQ/mCYCsC8106kDU0AdwRnvYZArWRcAl0dcYJq1hWCb3hBrumbDAVMwAC82WoRvgMnVMDBnB0nYZFTbE6BBvdUGqVqCbjBIk3PyFFR/NU7EKzru+qZsau3ryPwwCRLKYOzutZuCL6fUmWeJGzNzL/RxAMrUmASSCkkAayk2IxPlwhAAYGpsiHQjbLccfdOY5gKkCXAMi7SscAwbQpAnKyctWyUZ6z8ja3OGMepwD8asz+9FnSvbhU8uVOHFIwQsI3/p0CfhuqCSQuxLqsN6mu8SS+N42MAAAAASUVORK5CYII=",
			                "pixelOffset" : {
			                    "cartesian2" : [0.0, 0.0]
			                },
			                "scale" : 0.8333333333333334,
			                "show" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "boolean" : true
			                }],
			                "verticalOrigin" : "BOTTOM"
			            },
			            "label" : {
			                "fillColor" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "rgba" : [255, 255, 0, 255]
			                }],
			                "font" : "bold 10pt Segoe UI Semibold",
			                "horizontalOrigin" : "LEFT",
			                "outlineColor" : {
			                    "rgba" : [0, 0, 0, 255]
			                },
			                "pixelOffset" : {
			                    "cartesian2" : [10.0, 0.0]
			                },
			                "scale" : 1.0,
			                "show" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "boolean" : true
			                }],
			                "style" : "FILL",
			                "text" : "Vehicle",
			                "verticalOrigin" : "CENTER"
			            },
			            "path" : {
			                "color" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "rgba" : [255, 255, 0, 255]
			                }],
			                "outlineWidth" : 0.0,
			                "width" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "number" : 5.0
			                }],
			                "show" : [{
			                    "interval" : "2012-08-04T16:00:00Z/2012-08-04T18:00:00Z",
			                    "boolean" : true
			                }]
			            },
			            "position" : {
			                "interpolationAlgorithm" : "LAGRANGE",
			                "interpolationDegree" : 1,
			                "epoch" : "2012-08-04T16:00:00Z",
			                // Trimmed to just 2 points
			                "cartesian" : [0.0, -2379754.6637012, -4665332.88013588, 3628133.68924173,
			                               3894.996219574019, -2291336.52323822, -4682359.21232197, 3662718.52171165]
			            }
				    }];
	                var source = 'Inline Czml';
	                Cesium.processCzml(czml, dynamicObjectCollection, source);
	                var availability = dynamicObjectCollection.computeAvailability();

	                function tick() {
	                    scene.initializeFrame();
	                    visualizers.update(availability.start);
	                    scene.render();
	                    Cesium.requestAnimationFrame(tick);
	                }
	                tick();
                }

                var CzmlUri = 'S355_museumplein.json';
                Cesium.loadJson(CzmlUri).then(function(jsonData) {
	                Cesium.processCzml(jsonData, dynamicObjectCollection, CzmlUri);
	                var availability = dynamicObjectCollection.computeAvailability();

var clock = new Cesium.Clock({
   startTime : availability.start,
   stopTime : availability.stop,
   clockRange : Cesium.ClockRange.LOOP,
   clockStep: Cesium.ClockStep.TICK_DEPENDENT,
   multiplier: 100.0
});
animationController = new Cesium.AnimationController(clock);
animationController.pause();

	                // TODO make dynamic
	                scene.getCamera().controller.lookAt(
	                		   new Cesium.Cartesian3(3908274.743553265,
	                				   333858.3656380346,
	                				   5109429.146449581),
                               new Cesium.Cartesian3(-0.649259415780479,
                            		   -0.0669987353267151,
                            		   -0.7576103091200671),
                               new Cesium.Cartesian3(-0.7557019795828156,
                            		   -0.05565937466521455,
                            		   0.6525462068407336)
	                );

					function updateAndRender() {
			    		var currentTime = animationController.update();
	                    scene.initializeFrame(currentTime);
						// TODO print current time somewhere
						Ext.getCmp('progress').setValue(currentTime.toIso8601());
	                    visualizers.update(currentTime);
	                    scene.render();
	                    Cesium.requestAnimationFrame(updateAndRender);
	                }
	                Cesium.requestAnimationFrame(updateAndRender);


                }, function() {
	            	   alert('Loading czml file failed');
	            });

			    // Prevent right-click from opening a context menu.
			    canvas.oncontextmenu = function () {
			        return false;
			    };
			}
		});

		win = Ext.create('Ext.window.Window', {
			width : 500,
			height : 500,
			title : 'Museumplein',
			layout: 'fit',
			maximizable: true,
			items: [{
				xtype: 'cesium'
			}],
			dockedItems: [{
			    xtype: 'toolbar',
			    dock: 'bottom',
			    items: [{
					id: 'progress',
					xtype: 'textfield',
					value: '0'
				}, {
					xtype: 'combo',
					store: [1, 10, 50, 100, 200, 500],
					value: 100,
					width: 50,
					listeners: {
						change: function(field, value) {
							animationController.clock.multiplier = value*1.0;
						}
					}
				} ,{
					iconCls: 'play',
					toolTip: 'Play',
					handler: function() { animationController.play(); }
				}, {
					iconCls: 'pause',
					toolTip: 'Pause',
					handler: function() { animationController.pause(); }
				}, {
					iconCls: 'rewind',
					toolTip: 'Rewind',
					handler: function() { animationController.reset(); }
				}]
			}]
		});
		win.show();
	});
</script>
</head>
<body>
	<div id="cesiumContainer"></div>
	<div id="TODO">
	<h1>TODO</h1>
	<ul>
	<li>Show popup when point is clicked</li>
	<li>Show summery when point is hovered/mouseovered</li>
	<li>Color points/line segments by annotation</li>
	<li>Increase detail Bing Satellite on zoom level, more detail is shown to late</li>
	<li>Add terrain elevation</li>
	<li></li>
	</ul>
	</div>
</body>
</html>
