<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Extjs - Google Earth - Helloworld</title>
<link rel="stylesheet" href="extjs/resources/css/ext-all.css"
	type="text/css"></link>
<style>

.play {
  background-image: url(famfamfam_silk_icons/icons/control_play.png) !important;
}

.pause {
  background-image: url(famfamfam_silk_icons/icons/control_pause.png) !important;
}

.rewind {
  background-image: url(famfamfam_silk_icons/icons/control_rewind.png) !important;
}
</style>
<script type="text/javascript" src="extjs/ext-all-dev.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load("earth", "1");
var earth;
var gei;

Ext.require([
   'Ext.window.Window',
   'Ext.form.field.Text',
   'Ext.form.field.ComboBox'
]);

Ext.onReady(function() {
//	google.setOnLoadCallback(function() {

	Ext.define('Esc.google.Earth', {
		extend: 'Ext.Component',
		alias: 'widget.earth',
		onResize: function() {
            var canvas = this.getEl().dom;
			var width = canvas.clientWidth;
	        var height = canvas.clientHeight;

	        if (canvas.width === width && canvas.height === height) {
	            return;
	        }

	        canvas.width = width;
	        canvas.height = height;
		},
		afterRender: function() {
			google.earth.createInstance(this.getEl().dom, this.initCallback.bind(this));
		},
		initCallback: function(instance) {
			var ge = instance;
			gei = instance;
			this.ge = instance;
			//this.ge.getTime().getControl().setVisibility(this.ge.VISIBILITY_HIDE);
			this.ge.getLayerRoot().enableLayerById(this.ge.LAYER_BUILDINGS, true);
			this.ge.getLayerRoot().enableLayerById(this.ge.LAYER_TERRAIN, true);
//			this.ge.getSun().setVisibility(true);
//			this.ge.getOptions().setAtmosphereVisibility(true);

			this.ge.getWindow().setVisibility(true);

			var href = 'http://145.100.61.22/workspace4/ExtJS-Cesium/S355_museumplein.kml';

			function link() {
			var link = ge.createLink('');
			link.setHref(href);
			var networkLink = ge.createNetworkLink('');
			networkLink.set(link, true, false); // Sets the link, refreshVisibility, and flyToView
			ge.getFeatures().appendChild(networkLink);
			}

//			function fetch() {
			var me = this;
			google.earth.fetchKml(this.ge, href, function(object) {
				me.kmlFeature = object;
				me.ge.getFeatures().appendChild(object);
				//me.ge.getView().setAbstractView(object.getAbstractView());
				//me.player = me.ge.getTourPlayer();
				//me.player.setTour(object);
				//me.player.play();
				// goto last frame
				//me.player.setCurrentTime(me.player.getDuration()-1);

//				t = gei.createTimeSpan('');
//				t.getBegin().set('2010-06-28T00:12:47Z');
//				t.getEnd().set('2010-06-28T17:43:09Z');
				//me.ge.getTime().setTimePrimitive(t);
			});
//			}

			function hand() {
			Ext.Ajax.request({
				url: 'S355_museumplein.json',
				success: function(response) {
					var json = Ext.decode(response.responseText);
					var lsp = gei.createPlacemark('');
					var ls = gei.createLineString('');
					ls.setExtrude(true);
					ls.setAltitudeMode(gei.ALTITUDE_RELATIVE_TO_GROUND);
					lsp.setGeometry(ls);
					var ps = json[0]['position']['cartographicDegrees'];
					ps.forEach(function(v, i) {
						if (i % 4 == 0 ) {
							ls.getCoordinates().pushLatLngAlt(ps[i+1],ps[i+2],ps[i+3]);
						}
					});

					lsp.setStyleSelector(ge.createStyle(''));
			        var lineStyle = lsp.getStyleSelector().getLineStyle();
			        lineStyle.setWidth(5);
			        lineStyle.getColor().set('9900ffff');  // aabbggrr format

					gei.getFeatures().appendChild(lsp);
				}
			});
			}
		},
	});

	earth = Ext.create('Esc.google.Earth');

	win = Ext.create('Ext.window.Window', {
		width : 500,
		height : 500,
		title : 'Museumplein',
		layout: 'fit',
		maximizable: true,
		items: [earth],
		dockedItems: [{
		    xtype: 'toolbar',
		    dock: 'bottom',
		    items: [{
				iconCls: 'center',
				toolTip: 'Center',
				handler: function() {
					var av = earth.kmlFeature.getAbstractView();
					gei.getView().setAbstractView(av);
					var tp = earth.kmlFeature.getTimePrimitive();
					gei.getTime().setTimePrimitive(tp);
				}
			}, {
				iconCls: 'play',
				toolTip: 'Play',
				handler: function() {
					earth.ge.getTourPlayer().play();
				}
			}, {
				iconCls: 'pause',
				toolTip: 'Pause',
				handler: function() {
					earth.ge.getTourPlayer().pause();
				}
			}, {
				iconCls: 'rewind',
				toolTip: 'Rewind',
				handler: function() {
					earth.ge.getTourPlayer().reset();
				}
			}]
		}]
	});
	win.show();
	//});
});
</script>
</head>
<body>
	<div id="earthContainer"></div>
	<div>
	<h1>TODO</h1>
	<ol>
	<li>Externalize play controls</li>
	<li>Change appearance of track within a certain time range</li>
	<li>Click on point gives datetime of that point</li>
	</ol>
	</div>
</body>
</html>